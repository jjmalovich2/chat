<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ava and JJ ðŸ’–</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      /* --- DARK MODE CONFIG --- */
      :root {
        --insta-bg: #000000;
        --insta-gray: #262626;
        --insta-blue: #0095f6;
        --msg-received: #262626;
        --msg-sent: #3797f0;
        --text-main: #f5f5f5;
        --time-text: #8e8e8e; /* Color for the timestamps */
      }

      body {
        background-color: #121212;
        color: var(--text-main);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        display: flex;
        justify-content: center;
        height: 100vh;
      }

      .chat-wrapper {
        width: 100%;
        max-width: 450px;
        background: var(--insta-bg);
        display: flex;
        flex-direction: column;
        border-left: 1px solid var(--insta-gray);
        border-right: 1px solid var(--insta-gray);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        position: relative;
      }

      /* --- Header --- */
      header {
        background: var(--insta-bg);
        border-bottom: 1px solid var(--insta-gray);
        padding: 10px 0;
        z-index: 10;
      }
      .header-main h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        padding-bottom: 10px;
      }

      /* --- Active List --- */
      #activeList {
        display: flex;
        gap: 15px;
        padding: 5px 15px;
        overflow-x: auto;
        scrollbar-width: none;
      }
      #activeList::-webkit-scrollbar {
        display: none;
      }

      .user-status {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        min-width: 60px;
      }
      .avatar-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        padding: 2px;
        margin-bottom: 4px;
        background: linear-gradient(
          45deg,
          #f09433 0%,
          #e6683c 25%,
          #dc2743 50%,
          #cc2366 75%,
          #bc1888 100%
        );
      }
      .avatar-inner {
        width: 100%;
        height: 100%;
        background: var(--insta-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 18px;
      }
      .status-dot {
        height: 13px;
        width: 13px;
        background-color: #1ed760;
        border: 2px solid var(--insta-bg);
        border-radius: 50%;
        position: absolute;
        bottom: 22px;
        right: 8px;
      }
      .username-label {
        font-size: 11px;
        max-width: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* --- Messages Area --- */
      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* NEW: Timestamp Separator */
      .time-separator {
        text-align: center;
        color: var(--time-text);
        font-size: 11px;
        font-weight: 500;
        margin: 15px 0 5px 0;
      }

      .message {
        padding: 10px 16px;
        border-radius: 22px;
        max-width: 75%;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
        position: relative;
        cursor: pointer;
      }

      .sent {
        align-self: flex-end;
        background-color: var(--msg-sent);
        color: white;
        border-bottom-right-radius: 4px;
      }
      .received {
        align-self: flex-start;
        background-color: var(--msg-received);
        border-bottom-left-radius: 4px;
      }
      .sender-tag {
        font-size: 10px;
        font-weight: 600;
        margin-bottom: 2px;
        opacity: 0.7;
        color: #aaa;
        margin-left: 10px;
      }

      .chat-image {
        max-width: 100%;
        border-radius: 12px;
        margin-top: 5px;
        display: block;
      }

      /* --- Reply Styling --- */
      .reply-quote-block {
        background-color: rgba(0, 0, 0, 0.2);
        border-left: 3px solid rgba(255, 255, 255, 0.5);
        padding: 8px 10px;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 12px;
        display: flex;
        flex-direction: column;
      }
      .reply-sender {
        font-weight: 700;
        margin-bottom: 2px;
        opacity: 0.8;
      }
      .reply-text {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        opacity: 0.8;
      }

      #replyPreviewBar {
        background-color: #1e1e1e;
        padding: 10px 15px;
        border-top: 1px solid var(--insta-gray);
        display: none;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #ddd;
      }
      .replying-to-label {
        font-weight: 600;
        color: var(--insta-blue);
        display: block;
        margin-bottom: 2px;
      }

      /* --- Input Bar --- */
      .input-area {
        padding: 15px;
        border-top: 1px solid var(--insta-gray);
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--insta-bg);
      }

      #imageBtn {
        background: none;
        border: none;
        color: var(--text-main);
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
      }
      #msgInput {
        flex: 1;
        padding: 12px 20px;
        border: 1px solid var(--insta-gray);
        border-radius: 25px;
        outline: none;
        font-size: 15px;
        background: #262626;
        color: white;
      }
      #sendBtn {
        color: var(--insta-blue);
        background: none;
        border: none;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <header>
        <div class="header-main"><h3>Direct ðŸ’–</h3></div>
        <div id="activeList"></div>
      </header>

      <div id="messages">
        <div
          style="
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
          "
        >
          Loading chat...
        </div>
      </div>

      <div id="replyPreviewBar">
        <div class="reply-info">
          <span class="replying-to-label">Replying...</span>
          <span id="replyPreviewText" style="color: #aaa">Text</span>
        </div>
        <button
          id="cancelReplyBtn"
          style="background: none; border: none; color: #888; font-size: 20px"
        >
          &times;
        </button>
      </div>

      <div class="input-area">
        <input type="file" id="fileInput" accept="image/*" hidden />
        <button id="imageBtn">ðŸ“·</button>
        <input
          type="text"
          id="msgInput"
          placeholder="Message..."
          autocomplete="off"
        />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <script>
      // --- 1. CONFIGURATION ---
      const SUPABASE_URL = "https://xyvyocpdekeewoyvomuv.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5dnlvY3BkZWtlZXdveXZvbXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjc0NTEsImV4cCI6MjA4NTc0MzQ1MX0.8VkWO7vxdm4GrMp2FCeF4Ds7sxUVWo1AxOrxbeu4f4Y";

      const { createClient } = supabase;
      const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      let currentReplyData = null;
      let lastMessageTime = null; // Tracks the time of the previous message

      window.addEventListener("DOMContentLoaded", () => {
        let myName = localStorage.getItem("chat-user");
        if (!myName) {
          myName = prompt("Enter your name for the chat:") || "Guest";
          localStorage.setItem("chat-user", myName);
        }

        const msgInput = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");
        const msgDiv = document.getElementById("messages");
        const activeListDiv = document.getElementById("activeList");
        const replyPreviewBar = document.getElementById("replyPreviewBar");
        const imageBtn = document.getElementById("imageBtn");
        const fileInput = document.getElementById("fileInput");

        // --- HELPER: FORMAT TIME ---
        function formatTime(dateObj) {
          // Returns: "Mon 10:30 AM" or similar based on locale
          return dateObj.toLocaleTimeString([], {
            weekday: "short",
            hour: "numeric",
            minute: "2-digit",
          });
        }

        // --- RENDER MESSAGE ---
        function renderMessage(data) {
          const currentMsgTime = new Date(data.created_at);

          // 1. CALCULATE TIME DIFFERENCE
          // If no last time (first msg) OR diff > 5 minutes (300000ms)
          if (
            !lastMessageTime ||
            currentMsgTime - lastMessageTime > 5 * 60 * 1000
          ) {
            const timeDiv = document.createElement("div");
            timeDiv.className = "time-separator";
            timeDiv.innerText = formatTime(currentMsgTime);
            msgDiv.appendChild(timeDiv);

            // Update the tracker to this new timestamp
            lastMessageTime = currentMsgTime;
          }

          // 2. CREATE BUBBLE
          const isMe = data.sender === myName;
          const div = document.createElement("div");
          div.className = `message ${isMe ? "sent" : "received"}`;
          div.ondblclick = () =>
            initiateReply(
              data.message_type === "image" ? "ðŸ“· Image" : data.content,
              data.sender
            );

          // Reply Block
          let replyBlock = "";
          if (data.reply_to) {
            const rSender =
              data.reply_to.sender === myName ? "You" : data.reply_to.sender;
            replyBlock = `<div class="reply-quote-block"><span class="reply-sender">${rSender}</span><span class="reply-text">${data.reply_to.text}</span></div>`;
          }

          // Content
          let contentHtml = "";
          if (data.message_type === "image") {
            contentHtml = `<img src="${data.image_url}" class="chat-image" loading="lazy" />`;
          } else {
            contentHtml = `<div>${data.content}</div>`;
          }

          let nameLabel = !isMe
            ? `<span class="sender-tag">${data.sender}</span>`
            : "";

          div.innerHTML = `${nameLabel} ${replyBlock} ${contentHtml}`;
          msgDiv.appendChild(div);
          msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        // --- REPLY LOGIC ---
        function initiateReply(text, sender) {
          currentReplyData = { text: text, sender: sender };
          document.querySelector(
            ".replying-to-label"
          ).innerText = `Replying to ${sender}`;
          document.getElementById("replyPreviewText").innerText = text;
          replyPreviewBar.style.display = "flex";
          msgInput.focus();
        }
        document.getElementById("cancelReplyBtn").onclick = () => {
          currentReplyData = null;
          replyPreviewBar.style.display = "none";
        };

        // --- IMAGE UPLOAD ---
        imageBtn.onclick = () => fileInput.click();
        fileInput.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          msgInput.placeholder = "Uploading image...";
          imageBtn.disabled = true;

          const fileName = `${Date.now()}_${file.name.replace(/\s/g, "_")}`;
          const { data, error } = await _supabase.storage
            .from("chat-images")
            .upload(fileName, file);

          if (!error) {
            const { data: urlData } = _supabase.storage
              .from("chat-images")
              .getPublicUrl(fileName);
            await _supabase.from("messages").insert([
              {
                sender: myName,
                message_type: "image",
                image_url: urlData.publicUrl,
                content: "ðŸ“· Image",
                reply_to: currentReplyData,
              },
            ]);
          }
          msgInput.placeholder = "Message...";
          imageBtn.disabled = false;
          fileInput.value = "";
          if (currentReplyData)
            document.getElementById("cancelReplyBtn").click();
        };

        // --- HISTORY ---
        async function fetchHistory() {
          const { data, error } = await _supabase
            .from("messages")
            .select("*")
            .order("created_at", { ascending: true });
          if (!error) {
            msgDiv.innerHTML = "";
            lastMessageTime = null; // Reset time tracker for history load

            if (data.length === 0)
              msgDiv.innerHTML =
                '<div style="text-align:center; color:#666; margin-top:20px;">No messages yet.</div>';

            data.forEach(renderMessage);
          }
        }

        // --- TEXT SEND ---
        async function sendMessage() {
          const content = msgInput.value.trim();
          if (!content) return;
          msgInput.value = "";

          await _supabase.from("messages").insert([
            {
              content: content,
              sender: myName,
              message_type: "text",
              reply_to: currentReplyData,
            },
          ]);
          if (currentReplyData)
            document.getElementById("cancelReplyBtn").click();
        }

        // --- REALTIME ---
        const presenceChannel = _supabase.channel("online-users", {
          config: { presence: { key: myName } },
        });
        presenceChannel
          .on("presence", { event: "sync" }, () => {
            const state = presenceChannel.presenceState();
            const users = Object.keys(state);
            activeListDiv.innerHTML = users
              .map((name) => {
                const initial = name.charAt(0).toUpperCase();
                return `<div class="user-status"><div class="avatar-circle"><div class="avatar-inner">${initial}</div></div><span class="status-dot"></span><span class="username-label">${
                  name === myName ? "You" : name
                }</span></div>`;
              })
              .join("");
          })
          .subscribe(async (status) => {
            if (status === "SUBSCRIBED")
              await presenceChannel.track({
                online_at: new Date().toISOString(),
              });
          });

        _supabase
          .channel("chat-room")
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "messages" },
            (payload) => renderMessage(payload.new)
          )
          .subscribe();

        sendBtn.onclick = sendMessage;
        msgInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") sendMessage();
        });
        fetchHistory();
      });
    </script>
  </body>
</html>
