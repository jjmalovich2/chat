<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Our Private Chat</title>
    <style>
      :root {
        --primary-color: #ff4d6d;
        --bg-color: #fff0f3;
        --chat-bg: #ffffff;
        --received-msg: #f1f1f1;
        --sent-msg: #ff4d6d;
      }

      body {
        background-color: var(--bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        display: flex;
        justify-content: center;
        height: 100vh;
      }

      .chat-wrapper {
        width: 100%;
        max-width: 500px;
        background: var(--chat-bg);
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      }

      /* Header */
      header {
        padding: 15px;
        background: white;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .back-btn {
        text-decoration: none;
        color: var(--primary-color);
        font-weight: bold;
      }

      header h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #333;
      }

      /* Messages Area */
      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
        line-height: 1.4;
      }

      .sender-tag {
        display: block;
        font-size: 0.7rem;
        margin-bottom: 4px;
        font-weight: bold;
        opacity: 0.7;
      }

      /* Sent vs Received Styles */
      .sent {
        align-self: flex-end;
        background-color: var(--sent-msg);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .received {
        align-self: flex-start;
        background-color: var(--received-msg);
        color: #333;
        border-bottom-left-radius: 4px;
      }

      /* Input Bar */
      .input-area {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: white;
      }

      #messageInput {
        flex: 1;
        padding: 12px 18px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 16px; /* Prevents auto-zoom on iPhone */
      }

      #messageInput:focus {
        border-color: var(--primary-color);
      }

      #sendBtn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      #sendBtn:hover {
        opacity: 0.8;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="chat-wrapper">
      <header>
        <a href="../index.html" class="back-btn">‚¨Ö Back</a>
        <h2>Direct to My Valentine üíñ</h2>
      </header>

      <div id="messages"></div>

      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Write a secret..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
    <!-- "https://xyvyocpdekeewoyvomuv.supabase.co" -->
    <!-- "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5dnlvY3BkZWtlZXdveXZvbXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjc0NTEsImV4cCI6MjA4NTc0MzQ1MX0.8VkWO7vxdm4GrMp2FCeF4Ds7sxUVWo1AxOrxbeu4f4Y" -->
    <script>
      console.log("üöÄ Script execution started...");

      // 1. CONFIG
      const SUPABASE_URL = "https://xyvyocpdekeewoyvomuv.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5dnlvY3BkZWtlZXdveXZvbXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjc0NTEsImV4cCI6MjA4NTc0MzQ1MX0.8VkWO7vxdm4GrMp2FCeF4Ds7sxUVWo1AxOrxbeu4f4Y";

      console.log("üîó Connecting to URL:", SUPABASE_URL);

      // Check if the library is even loaded
      if (typeof supabase === "undefined") {
        console.error(
          "‚ùå ERROR: Supabase library is not loaded! Check your <script src='...'> tag."
        );
      } else {
        console.log("‚úÖ Supabase library detected.");
      }

      const { createClient } = supabase;
      const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      const msgInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const msgDiv = document.getElementById("messages");
      let myName = localStorage.getItem("chat-user") || "User";

      console.log("üë§ Current User Name:", myName);

      // 2. RENDER
      function renderMessage(data) {
        console.log("üì• Rendering message from:", data.sender);
        const div = document.createElement("div");
        div.className = `message ${
          data.sender === myName ? "sent" : "received"
        }`;
        div.innerHTML = `<span class="sender-tag">${data.sender}</span><div>${data.content}</div>`;
        msgDiv.appendChild(div);
        msgDiv.scrollTop = msgDiv.scrollHeight;
      }

      // 3. FETCH HISTORY
      async function fetchHistory() {
        console.log("‚è≥ Fetching history from Supabase...");
        try {
          const { data, error } = await _supabase
            .from("messages")
            .select("*")
            .order("created_at");

          if (error) {
            console.error("‚ùå SUPABASE FETCH ERROR:", error.message);
            msgDiv.innerHTML = `<div style="color:red">Error: ${error.message}</div>`;
          } else {
            console.log("üì¶ Data received. Row count:", data ? data.length : 0);
            msgDiv.innerHTML = "";
            if (data && data.length > 0) {
              data.forEach(renderMessage);
            } else {
              console.log("‚ÑπÔ∏è Table is empty.");
              msgDiv.innerHTML =
                '<div style="text-align:center; padding:20px; color:#999;">Table is empty. Send a message!</div>';
            }
          }
        } catch (err) {
          console.error("‚ùå CRITICAL SCRIPT ERROR during fetch:", err);
        }
      }

      // 4. SEND MESSAGE
      async function sendMessage() {
        const content = msgInput.value.trim();
        if (!content) {
          console.log("‚ö†Ô∏è Cannot send empty message.");
          return;
        }

        console.log("üì§ Sending message:", content);
        msgInput.value = "";

        try {
          const { error } = await _supabase
            .from("messages")
            .insert([{ content: content, sender: myName }]);

          if (error) {
            console.error("‚ùå SUPABASE INSERT ERROR:", error.message);
          } else {
            console.log("‚úÖ Message sent successfully!");
          }
        } catch (err) {
          console.error("‚ùå CRITICAL SCRIPT ERROR during send:", err);
        }
      }

      // 5. LISTENERS
      if (sendBtn) {
        sendBtn.onclick = sendMessage;
        console.log("‚úÖ Send button listener attached.");
      } else {
        console.error("‚ùå ERROR: Send button not found in HTML!");
      }

      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          console.log("‚å®Ô∏è Enter key detected.");
          sendMessage();
        }
      });

      // Real-time
      _supabase
        .channel("room1")
        .on(
          "postgres_changes",
          {
            event: "INSERT",
            schema: "public",
            table: "messages",
          },
          (payload) => {
            console.log("üîî Real-time update received!");
            renderMessage(payload.new);
          }
        )
        .subscribe();

      // Start
      fetchHistory();
    </script>
  </body>
</html>
